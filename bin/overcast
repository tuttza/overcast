#!/usr/bin/env ruby

require 'bundler/setup'
require 'overcast'
require 'optparse'

directory_store = Overcast::DirectoryStore.new


options = {}
OptionParser.new do |option|
  option.banner = 'Overcast'

  option.on('-a', '--add_dir PATH_TO_DIR', 'Add a directory to the directories.yml file') do |opt|
    options[:add_dir] = opt
  end

  option.on('-v', '--version', 'Display application version') do |opt|
    options[:version] = opt
  end

  option.on('-lbd', '--list-backup-dirs', 'Prints the list of directories from directories.yml') do |opt|
    options[:list_backup_directories] = opt
  end

  option.on('-h', '--help', 'Display commandline arguments and options') do
    puts option
  end

end.parse!

if options[:version]
  puts "Overcast #{Overcast::VERSION}"
end

if options[:list_backup_directories]
  dir_items = []
  
  directory_store.directories.each do |dir_path|
    dir_items << Overcast::DirectoryItem.new({ path: dir_path })
  end

  dirs = Overcast::Directory.new(directory_items: dir_items)

  dirs.display_all
end

if options[:add_dir]
  dir = options[:add_dir]

  if directory_store.directories.include?(dir)
    puts "The directory you are attempting to add has already been added.".light_yellow
    return
  end

  if directory_store.is_subdir?(File.basename(dir))
    puts "The directory you are attempting add has been included by a parent directory.".light_yellow
    return
  end
  
  if directory_store.add_directory(dir)
    puts "Successfully added: '#{dir}'".light_green
  end
  
end
